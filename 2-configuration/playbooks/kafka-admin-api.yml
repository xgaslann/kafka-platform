---
- name: Deploy Kafka Admin API
  hosts: platform
  become: true

  vars:
    api_image: kafka-admin-api:1.0.0
    api_port: 2020

  tasks:
    - name: Create app directory
      file:
        path: /opt/kafka-admin-api
        state: directory
        mode: '0755'

    - name: Copy source code
      copy:
        src: ../../3-services/kafka-admin-api/
        dest: /opt/kafka-admin-api/
        mode: '0644'

    - name: Make sure Dockerfile is present
      stat:
        path: /opt/kafka-admin-api/Dockerfile
      register: dockerfile

    - name: Debug - show copied files
      shell: ls -la /opt/kafka-admin-api/
      register: files_list

    - name: Show files
      debug:
        var: files_list.stdout_lines

    - name: Build Docker image
      shell: |
        cd /opt/kafka-admin-api
        docker build -t {{ api_image }} .
      register: build_result

    - name: Stop existing container
      shell: docker stop kafka-admin-api || true
      ignore_errors: true

    - name: Remove existing container
      shell: docker rm kafka-admin-api || true
      ignore_errors: true

    - name: Run container
      shell: |
        docker run -d \
          --name kafka-admin-api \
          --restart unless-stopped \
          --network host \
          -e KAFKA_BOOTSTRAP_SERVERS={{ groups['kafka_broker'] | map('extract', hostvars, 'private_ip') | map('regex_replace', '$', ':9092') | join(',') }} \
          {{ api_image }}

    - name: Wait for API to be ready
      uri:
        url: "http://localhost:{{ api_port }}/health"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 10
      delay: 3
