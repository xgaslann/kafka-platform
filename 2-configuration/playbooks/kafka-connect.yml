---
- name: Deploy Kafka Connect with Docker Compose
  hosts: kafka_connect
  become: true

  vars:
    jmx_exporter_version: "1.0.1"

  tasks:
    - name: Install Docker dependencies
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg --yes
      args:
        creates: /usr/share/keyrings/docker-archive-keyring.gpg

    - name: Add Docker repository
      shell: |
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
      args:
        creates: /etc/apt/sources.list.d/docker.list

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Stop cp-ansible deployed Kafka Connect service
      systemd:
        name: confluent-kafka-connect
        state: stopped
        enabled: no
      ignore_errors: true

    - name: Create kafka-connect directory
      file:
        path: /opt/kafka-connect
        state: directory
        mode: '0755'

    - name: Create JMX exporter directory
      file:
        path: /opt/kafka-connect/jmx-exporter
        state: directory
        mode: '0755'

    - name: Download JMX Exporter
      get_url:
        url: "https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/{{ jmx_exporter_version }}/jmx_prometheus_javaagent-{{ jmx_exporter_version }}.jar"
        dest: /opt/kafka-connect/jmx-exporter/jmx_prometheus_javaagent.jar
        mode: '0644'

    - name: Create JMX Exporter config
      copy:
        dest: /opt/kafka-connect/jmx-exporter/kafka-connect.yml
        mode: '0644'
        content: |
          lowercaseOutputName: true
          lowercaseOutputLabelNames: true
          rules:
            - pattern: 'kafka.connect<type=connector-metrics, connector=(.+)><>(.+): (.+)'
              name: kafka_connect_connector_$2
              labels:
                connector: $1
              type: GAUGE
            - pattern: 'kafka.connect<type=connector-task-metrics, connector=(.+), task=(.+)><>(.+): (.+)'
              name: kafka_connect_task_$3
              labels:
                connector: $1
                task: $2
              type: GAUGE
            - pattern: 'kafka.connect<type=connect-worker-metrics><>(.+): (.+)'
              name: kafka_connect_worker_$1
              type: GAUGE

    - name: Create docker-compose.yml
      copy:
        dest: /opt/kafka-connect/docker-compose.yml
        mode: '0644'
        content: |
          services:
            kafka-connect:
              image: confluentinc/cp-kafka-connect:8.1.0
              hostname: connect-1
              container_name: kafka-connect
              network_mode: host
              environment:
                CONNECT_BOOTSTRAP_SERVERS: "{{ groups['kafka_broker'] | map('extract', hostvars, 'private_ip') | map('regex_replace', '$', ':9092') | join(',') }}"
                CONNECT_REST_PORT: 8083
                CONNECT_REST_ADVERTISED_HOST_NAME: connect-1
                CONNECT_GROUP_ID: connect-cluster
                CONNECT_CONFIG_STORAGE_TOPIC: connect-cluster-configs
                CONNECT_OFFSET_STORAGE_TOPIC: connect-cluster-offsets
                CONNECT_STATUS_STORAGE_TOPIC: connect-cluster-status
                CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 3
                CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 3
                CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 3
                CONNECT_KEY_CONVERTER: org.apache.kafka.connect.storage.StringConverter
                CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.storage.StringConverter
                CONNECT_PLUGIN_PATH: /usr/share/java,/usr/share/confluent-hub-components
                KAFKA_OPTS: "-javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=7071:/opt/jmx-exporter/kafka-connect.yml"
              volumes:
                - connect-plugins:/usr/share/confluent-hub-components
                - /opt/kafka-connect/jmx-exporter:/opt/jmx-exporter:ro
              restart: unless-stopped
          volumes:
            connect-plugins:

    - name: Stop existing Docker containers
      shell: cd /opt/kafka-connect && docker compose down || true
      ignore_errors: true

    - name: Start Kafka Connect
      shell: cd /opt/kafka-connect && docker compose up -d

    - name: Wait for Kafka Connect to be ready
      uri:
        url: "http://localhost:8083/"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 10

    - name: Download HTTP Source Connector
      get_url:
        url: "https://github.com/castorm/kafka-connect-http/releases/download/v0.8.11/kafka-connect-http-0.8.11-plugin.tar.gz"
        dest: /tmp/kafka-connect-http-0.8.11-plugin.tar.gz
        mode: '0644'

    - name: Extract HTTP Source Connector
      unarchive:
        src: /tmp/kafka-connect-http-0.8.11-plugin.tar.gz
        dest: /tmp/
        remote_src: yes

    - name: Copy plugin to container
      shell: docker cp /tmp/kafka-connect-http kafka-connect:/usr/share/confluent-hub-components/

    - name: Restart Kafka Connect to load plugin
      shell: cd /opt/kafka-connect && docker compose restart

    - name: Wait for Kafka Connect to be ready after plugin install
      uri:
        url: "http://localhost:8083/"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 10

    - name: Verify HTTP Source Connector plugin loaded
      uri:
        url: "http://localhost:8083/connector-plugins"
        return_content: yes
      register: plugins
      until: "'HttpSourceConnector' in plugins.content"
      retries: 5
      delay: 5

    - name: Show available plugins
      debug:
        var: plugins.json
